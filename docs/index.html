<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wedding Elite Premium</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Rubik', 'sans-serif'] },
                    colors: {
                        ivory: '#F5F5DC',
                        sage: '#D0E6D2',
                        sageDark: '#8FBC94',
                        dusk: '#4C5578',
                        gold: '#D4AF37',
                        warm: '#E6B89C', // For dynamic shift
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(76, 85, 120, 0.07)',
                        'neumorph': '20px 20px 60px #d1d1bb, -20px -20px 60px #ffffff'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-color: #F5F5DC;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --text-main: #4C5578;
        }

        /* Dynamic Theme: Warm/Festive Mode */
        body.theme-festive {
            --bg-color: #F0E6D2; /* Warmer Ivory */
        }
        body.theme-festive .accent-target {
            color: #D4AF37 !important; /* Gold override */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 1.5s ease;
        }
        
        /* Premium Glassmorphism */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(76, 85, 120, 0.05);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Smooth Transitions */
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Radial Progress */
        .radial-progress {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .radial-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s ease-in-out;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        
        /* Post-it Note Style */
        .note-card {
            transition: transform 0.2s;
        }
        .note-card:hover {
            transform: scale(1.02) rotate(1deg);
            z-index: 10;
        }
    </style>
</head>
<body class="pb-32 antialiased selection:bg-sage selection:text-dusk">

    <!-- Sticky Header -->
    <header class="fixed top-0 left-0 right-0 z-40 glass transition-all-300">
        <div class="max-w-3xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-sage flex items-center justify-center text-dusk shadow-sm accent-target transition-colors duration-1000">
                    <i class="fa-solid fa-ring"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-dusk tracking-wide">WEDDING ELITE</h1>
                    <p class="text-[10px] text-dusk/60 font-medium tracking-widest uppercase">Premium Planner</p>
                </div>
            </div>
            <button onclick="App.openSettings()" class="w-10 h-10 rounded-full bg-white/50 hover:bg-white flex items-center justify-center text-dusk transition-colors">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-3xl mx-auto px-5 pt-24 space-y-8">

        <!-- DASHBOARD VIEW -->
        <div id="view-home" class="view-section">
            <!-- Smart Dashboard Hero -->
            <section class="glass rounded-3xl p-8 shadow-glass text-center relative overflow-hidden animate-slide-up">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-sage to-dusk opacity-50"></div>
                
                <div class="flex justify-between items-start mb-6">
                    <div class="text-right">
                        <h2 class="text-2xl font-bold text-dusk" id="coupleNamesDisplay">...</h2>
                        <p class="text-sm text-dusk/60 font-light" id="weddingDateDisplay">--/--/----</p>
                    </div>
                    <!-- Radial Progress -->
                    <div class="relative w-16 h-16">
                        <svg class="w-full h-full radial-progress" viewBox="0 0 100 100">
                            <circle class="text-dusk/10 stroke-current" stroke-width="8" cx="50" cy="50" r="45" fill="transparent"></circle>
                            <circle id="progressCircle" class="text-sage stroke-current radial-circle accent-target" stroke-width="8" stroke-linecap="round" cx="50" cy="50" r="45" fill="transparent" stroke-dashoffset="283"></circle>
                        </svg>
                        <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-xs font-bold text-dusk">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Countdown -->
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <div class="bg-white/40 rounded-2xl p-3 backdrop-blur-sm">
                        <span class="block text-2xl font-bold text-dusk" id="timerDays">0</span>
                        <span class="text-[10px] text-dusk/60 uppercase tracking-wider">ימים</span>
                    </div>
                    <div class="bg-white/40 rounded-2xl p-3 backdrop-blur-sm">
                        <span class="block text-2xl font-bold text-dusk" id="timerHours">0</span>
                        <span class="text-[10px] text-dusk/60 uppercase tracking-wider">שעות</span>
                    </div>
                    <div class="bg-white/40 rounded-2xl p-3 backdrop-blur-sm">
                        <span class="block text-2xl font-bold text-dusk" id="timerMins">0</span>
                        <span class="text-[10px] text-dusk/60 uppercase tracking-wider">דקות</span>
                    </div>
                    <div class="bg-white/40 rounded-2xl p-3 backdrop-blur-sm">
                        <span class="block text-2xl font-bold text-dusk" id="timerSecs">0</span>
                        <span class="text-[10px] text-dusk/60 uppercase tracking-wider">שניות</span>
                    </div>
                </div>
            </section>

            <!-- Quick Actions Grid -->
            <div class="grid grid-cols-2 gap-4 mt-6 animate-slide-up" style="animation-delay: 0.1s;">
                <div onclick="App.navTo('rabbinate')" class="glass p-4 rounded-2xl cursor-pointer hover:bg-white/60 transition-colors flex flex-col items-center justify-center gap-2 h-32 group">
                    <i class="fa-solid fa-scroll text-2xl text-dusk/80"></i>
                    <span class="font-medium text-sm">הרבנות</span>
                </div>
                <div onclick="App.navTo('vendors')" class="glass p-4 rounded-2xl cursor-pointer hover:bg-white/60 transition-colors flex flex-col items-center justify-center gap-2 h-32 group">
                    <i class="fa-solid fa-store text-2xl text-dusk/80"></i>
                    <span class="font-medium text-sm">ספקים</span>
                </div>
            </div>
        </div>

        <!-- BUDGET VIEW -->
        <div id="view-budget" class="view-section hidden">
            <section class="animate-slide-up">
                <h3 class="text-xl font-bold text-dusk mb-4 px-2">מנוע תקציב חכם</h3>
                
                <!-- Gift Predictor -->
                <div class="glass p-5 rounded-2xl mb-6 border-r-4 border-sage">
                    <h4 class="font-bold text-sm text-dusk mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-calculator text-sageDark"></i> צפי מתנות (ממוצע ארצי)
                    </h4>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <label class="text-[10px] text-dusk/60 block mb-1">משפחה (₪1500)</label>
                            <input type="number" id="guestsFamily" placeholder="0" class="w-full bg-white/50 rounded-lg p-2 text-center text-sm outline-none focus:ring-1 focus:ring-sage" oninput="Budget.calcGifts()">
                        </div>
                        <div>
                            <label class="text-[10px] text-dusk/60 block mb-1">חברים (₪500)</label>
                            <input type="number" id="guestsFriends" placeholder="0" class="w-full bg-white/50 rounded-lg p-2 text-center text-sm outline-none focus:ring-1 focus:ring-sage" oninput="Budget.calcGifts()">
                        </div>
                        <div>
                            <label class="text-[10px] text-dusk/60 block mb-1">עבודה (₪350)</label>
                            <input type="number" id="guestsWork" placeholder="0" class="w-full bg-white/50 rounded-lg p-2 text-center text-sm outline-none focus:ring-1 focus:ring-sage" oninput="Budget.calcGifts()">
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-dusk/10 flex justify-between items-center">
                        <span class="text-xs font-medium">צפי הכנסות:</span>
                        <span class="text-lg font-bold text-sageDark" id="predictedIncome">₪0</span>
                    </div>
                </div>

                <!-- Budget Summary -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="glass p-4 rounded-2xl">
                        <p class="text-xs text-dusk/60 mb-1">תקציב יעד</p>
                        <p class="font-bold text-dusk text-xl" id="totalBudgetDisplay">₪0</p>
                    </div>
                    <div class="glass p-4 rounded-2xl">
                        <p class="text-xs text-dusk/60 mb-1">נותר להוצאות</p>
                        <p class="font-bold text-sageDark text-xl" id="totalRemainingDisplay">₪0</p>
                    </div>
                </div>

                <!-- Categories -->
                <div id="budgetGrid" class="space-y-3"></div>
            </section>
        </div>

        <!-- RABBINATE VIEW -->
        <div id="view-rabbinate" class="view-section hidden">
            <section class="animate-slide-up">
                <h3 class="text-xl font-bold text-dusk mb-4 px-2">הליך ברבנות</h3>
                <div class="glass p-4 rounded-2xl mb-4">
                    <p class="text-sm text-dusk/80 leading-relaxed">
                        <i class="fa-solid fa-circle-info text-sageDark ml-1"></i>
                        יש לפתוח תיק נישואין בין 45 יום ל-3 חודשים לפני החתונה.
                    </p>
                </div>
                <div id="rabbinateList" class="space-y-3"></div>
            </section>
        </div>

        <!-- VENDORS VIEW -->
        <div id="view-vendors" class="view-section hidden">
            <section class="animate-slide-up">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="text-xl font-bold text-dusk">ספקים וחוזים</h3>
                    <button onclick="Vendors.add()" class="w-8 h-8 bg-sage rounded-full text-white flex items-center justify-center shadow-sm hover:bg-sageDark transition-colors"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="vendorsList" class="grid grid-cols-1 gap-4"></div>
            </section>
        </div>

        <!-- NOTES VIEW -->
        <div id="view-notes" class="view-section hidden">
            <section class="animate-slide-up">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="text-xl font-bold text-dusk">לוח השראה</h3>
                    <button onclick="Notes.add()" class="w-8 h-8 bg-sage rounded-full text-white flex items-center justify-center shadow-sm hover:bg-sageDark transition-colors"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="notesGrid" class="grid grid-cols-2 gap-4"></div>
            </section>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 z-50 glass-nav pb-6 pt-2">
        <div class="flex justify-around items-center h-16 max-w-3xl mx-auto px-2">
            <button onclick="App.navTo('home')" class="nav-btn flex flex-col items-center gap-1 text-dusk/40 transition-colors w-14" data-target="home">
                <i class="fa-solid fa-house text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">בית</span>
            </button>
            <button onclick="App.navTo('budget')" class="nav-btn flex flex-col items-center gap-1 text-dusk/40 transition-colors w-14" data-target="budget">
                <i class="fa-solid fa-sack-dollar text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">תקציב</span>
            </button>
            <button onclick="App.navTo('rabbinate')" class="nav-btn flex flex-col items-center gap-1 text-dusk/40 transition-colors w-14" data-target="rabbinate">
                <i class="fa-solid fa-scroll text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">רבנות</span>
            </button>
            <button onclick="App.navTo('vendors')" class="nav-btn flex flex-col items-center gap-1 text-dusk/40 transition-colors w-14" data-target="vendors">
                <i class="fa-solid fa-store text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">ספקים</span>
            </button>
            <button onclick="App.navTo('notes')" class="nav-btn flex flex-col items-center gap-1 text-dusk/40 transition-colors w-14" data-target="notes">
                <i class="fa-solid fa-note-sticky text-xl mb-0.5"></i>
                <span class="text-[10px] font-medium">פתקים</span>
            </button>
        </div>
    </nav>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-dusk/20 backdrop-blur-sm" onclick="App.closeSettings()"></div>
        <div class="glass w-full max-w-md rounded-3xl shadow-neumorph relative z-10 p-6 animate-slide-up bg-ivory">
            <h3 class="text-xl font-bold text-dusk mb-6">הגדרות חתונה</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-dusk/70 mb-1">שם החתן</label>
                    <input type="text" id="groomNameInput" class="w-full bg-white/50 border border-white rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-sage transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-dusk/70 mb-1">שם הכלה</label>
                    <input type="text" id="brideNameInput" class="w-full bg-white/50 border border-white rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-sage transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-dusk/70 mb-1">תאריך החתונה</label>
                    <input type="date" id="weddingDateInput" class="w-full bg-white/50 border border-white rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-sage transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-dusk/70 mb-1">תקציב כולל (יעד)</label>
                    <input type="number" id="totalBudgetInput" class="w-full bg-white/50 border border-white rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-sage transition-all">
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                <button onclick="App.saveSettings()" class="flex-1 bg-sage text-dusk font-bold py-3 rounded-xl shadow-sm active:scale-95 transition-transform">
                    שמור שינויים
                </button>
                <button onclick="App.closeSettings()" class="px-6 py-3 rounded-xl text-dusk/50 font-medium hover:bg-white/50">
                    ביטול
                </button>
            </div>
        </div>
    </div>

    <!-- APP LOGIC -->
    <script type="module">
        /**
         * Wedding Elite Premium - Core Architecture
         * Uses Proxy for reactive state and debounced persistence.
         */

        const DB_KEY = 'wedding_elite_premium_v1';

        // --- Initial State ---
        const initialState = {
            totalBudget: 125000,
            guests: { family: 0, friends: 0, work: 0 },
            couple: {
                groom: "יוסי",
                bride: "חן",
                date: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0]
            },
            budget: [
                { id: 'venue', name: "אולם ואירוח", icon: "fa-utensils", planned: 80000, actual: 0, paid: 0 },
                { id: 'photo', name: "צילום", icon: "fa-camera", planned: 12000, actual: 0, paid: 0 },
                { id: 'dj', name: "מוזיקה", icon: "fa-music", planned: 8000, actual: 0, paid: 0 },
                { id: 'dress', name: "שמלה ואיפור", icon: "fa-shirt", planned: 10000, actual: 0, paid: 0 }
            ],
            rabbinate: [
                { id: 1, text: "פתיחת תיק נישואין", done: false },
                { id: 2, text: "הדרכת כלות", done: false },
                { id: 3, text: "תעודות רווקות", done: false },
                { id: 4, text: "אישור מקווה", done: false }
            ],
            vendors: [
                { id: 1, name: "אולמי בראשית", category: "אולם", price: 85000, rating: 5, kosher: true, contract: true },
                { id: 2, name: "צלם מגנטים", category: "אטרקציות", price: 1500, rating: 4, kosher: false, contract: false }
            ],
            notes: [
                { id: 1, text: "לבדוק עיצוב חופה בסגנון בוהו", color: "bg-yellow-100" },
                { id: 2, text: "רשימת שירים ל-DJ", color: "bg-purple-100" }
            ]
        };

        // --- Persistence Engine ---
        const saveToStorage = (state) => {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
        };
        
        // Debounce function
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };
        
        const debouncedSave = debounce(saveToStorage, 1000);

        // --- Reactive State Proxy ---
        const handler = {
            set(target, property, value) {
                target[property] = value;
                debouncedSave(state);
                // Trigger UI updates based on what changed
                if (property === 'budget' || property === 'guests') Budget.render();
                if (property === 'rabbinate') Rabbinate.render();
                if (property === 'vendors') Vendors.render();
                if (property === 'notes') Notes.render();
                if (property === 'couple') Dashboard.renderHero();
                return true;
            }
        };

        // Load or Init
        let loadedData = JSON.parse(localStorage.getItem(DB_KEY)) || initialState;
        loadedData = { ...initialState, ...loadedData };
        
        const state = new Proxy(loadedData, handler);

        // --- Modules ---

        const Theme = {
            update(daysRemaining) {
                const body = document.body;
                if (daysRemaining < 30) {
                    body.classList.add('theme-festive');
                } else {
                    body.classList.remove('theme-festive');
                }
            }
        };

        const Dashboard = {
            renderHero() {
                document.getElementById('coupleNamesDisplay').textContent = `${state.couple.groom} & ${state.couple.bride}`;
                document.getElementById('weddingDateDisplay').textContent = new Date(state.couple.date).toLocaleDateString('he-IL');
            },

            startTimer() {
                const animate = () => {
                    const now = new Date().getTime();
                    const weddingDate = new Date(state.couple.date).getTime();
                    const distance = weddingDate - now;

                    if (distance < 0) return;

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    document.getElementById('timerDays').innerText = days;
                    document.getElementById('timerHours').innerText = hours;
                    document.getElementById('timerMins').innerText = minutes;
                    document.getElementById('timerSecs').innerText = seconds;

                    // Theme Update
                    Theme.update(days);

                    // Radial Progress
                    const totalTime = 1000 * 60 * 60 * 24 * 365; 
                    const progress = Math.min(100, Math.max(0, 100 - (distance / totalTime * 100)));
                    const offset = 283 - (283 * progress / 100);
                    
                    const circle = document.getElementById('progressCircle');
                    if(circle) circle.style.strokeDashoffset = offset;
                    
                    const text = document.getElementById('progressText');
                    if(text) text.innerText = Math.floor(progress) + '%';

                    requestAnimationFrame(animate);
                };
                requestAnimationFrame(animate);
            }
        };

        const Budget = {
            calcGifts() {
                const fam = Number(document.getElementById('guestsFamily').value) || 0;
                const fri = Number(document.getElementById('guestsFriends').value) || 0;
                const wrk = Number(document.getElementById('guestsWork').value) || 0;
                
                state.guests = { family: fam, friends: fri, work: wrk };
                
                const total = (fam * 1500) + (fri * 500) + (wrk * 350);
                document.getElementById('predictedIncome').innerText = `₪${total.toLocaleString()}`;
            },

            render() {
                const grid = document.getElementById('budgetGrid');
                grid.innerHTML = '';
                
                let totalPaid = 0;
                
                state.budget.forEach((cat, idx) => {
                    totalPaid += Number(cat.paid || 0);
                    const percent = cat.planned > 0 ? Math.min(100, (cat.paid / cat.planned) * 100) : 0;
                    
                    const el = document.createElement('div');
                    el.className = 'glass p-3 rounded-xl flex items-center gap-3';
                    el.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-dusk">
                            <i class="fa-solid ${cat.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between mb-1">
                                <span class="font-bold text-sm text-dusk">${cat.name}</span>
                                <span class="text-xs text-dusk/60">₪${cat.paid} / ₪${cat.planned}</span>
                            </div>
                            <div class="w-full bg-white/30 h-1.5 rounded-full overflow-hidden">
                                <div class="bg-sage h-full accent-target" style="width: ${percent}%"></div>
                            </div>
                        </div>
                        <button onclick="Budget.edit(${idx})" class="text-dusk/40 hover:text-sageDark"><i class="fa-solid fa-pen"></i></button>
                    `;
                    grid.appendChild(el);
                });

                document.getElementById('totalBudgetDisplay').innerText = `₪${state.totalBudget.toLocaleString()}`;
                document.getElementById('totalRemainingDisplay').innerText = `₪${(state.totalBudget - totalPaid).toLocaleString()}`;
            },

            edit(idx) {
                const cat = state.budget[idx];
                const newPaid = prompt(`כמה שולם עבור ${cat.name}?`, cat.paid);
                if (newPaid !== null) {
                    state.budget[idx].paid = Number(newPaid);
                    state.budget = [...state.budget]; // Trigger proxy
                }
            }
        };

        const Rabbinate = {
            render() {
                const list = document.getElementById('rabbinateList');
                list.innerHTML = '';
                
                state.rabbinate.forEach((task, idx) => {
                    const el = document.createElement('div');
                    el.className = `p-4 rounded-xl border transition-all flex items-center gap-3 ${task.done ? 'bg-sage/20 border-sage' : 'bg-white/40 border-white'}`;
                    el.innerHTML = `
                        <div onclick="Rabbinate.toggle(${idx})" class="w-6 h-6 rounded-full border-2 border-dusk/20 flex items-center justify-center cursor-pointer ${task.done ? 'bg-sage border-sage' : ''}">
                            ${task.done ? '<i class="fa-solid fa-check text-white text-xs"></i>' : ''}
                        </div>
                        <span class="${task.done ? 'line-through text-dusk/50' : 'text-dusk font-medium'}">${task.text}</span>
                    `;
                    list.appendChild(el);
                });
            },

            toggle(idx) {
                state.rabbinate[idx].done = !state.rabbinate[idx].done;
                state.rabbinate = [...state.rabbinate];
                if (state.rabbinate[idx].done) App.confetti();
            }
        };

        const Vendors = {
            render() {
                const list = document.getElementById('vendorsList');
                list.innerHTML = '';
                
                state.vendors.forEach((v, idx) => {
                    const stars = '★'.repeat(v.rating) + '☆'.repeat(5 - v.rating);
                    const el = document.createElement('div');
                    el.className = 'glass p-4 rounded-2xl relative group';
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-[10px] uppercase tracking-wider text-dusk/50 bg-white/50 px-2 py-0.5 rounded-full">${v.category}</span>
                                <h4 class="font-bold text-lg text-dusk mt-1">${v.name}</h4>
                            </div>
                            <div class="text-gold text-sm tracking-widest">${stars}</div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <span class="text-xs px-2 py-1 rounded-md ${v.kosher ? 'bg-sage/30 text-dusk' : 'bg-red-100 text-red-800'}">
                                ${v.kosher ? 'כשר' : 'לא כשר'}
                            </span>
                            <span class="text-xs px-2 py-1 rounded-md ${v.contract ? 'bg-sage/30 text-dusk' : 'bg-yellow-100 text-yellow-800'}">
                                ${v.contract ? 'חוזה חתום' : 'אין חוזה'}
                            </span>
                        </div>
                        <button onclick="Vendors.delete(${idx})" class="absolute top-4 left-4 text-dusk/20 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                    `;
                    list.appendChild(el);
                });
            },

            add() {
                const name = prompt("שם העסק:");
                if (!name) return;
                state.vendors.push({
                    id: Date.now(),
                    name: name,
                    category: "כללי",
                    price: 0,
                    rating: 5,
                    kosher: confirm("האם יש תעודת כשרות?"),
                    contract: false
                });
                state.vendors = [...state.vendors];
            },

            delete(idx) {
                if(confirm("למחוק ספק זה?")) {
                    state.vendors.splice(idx, 1);
                    state.vendors = [...state.vendors];
                }
            }
        };

        const Notes = {
            render() {
                const grid = document.getElementById('notesGrid');
                grid.innerHTML = '';
                
                state.notes.forEach((note, idx) => {
                    const el = document.createElement('div');
                    el.className = `note-card p-4 rounded-xl shadow-sm min-h-[120px] flex flex-col justify-between ${note.color || 'bg-yellow-100'}`;
                    el.innerHTML = `
                        <p class="text-dusk font-handwriting text-sm leading-relaxed">${note.text}</p>
                        <button onclick="Notes.delete(${idx})" class="self-end text-dusk/30 hover:text-dusk"><i class="fa-solid fa-trash-can"></i></button>
                    `;
                    grid.appendChild(el);
                });
            },

            add() {
                const text = prompt("תוכן הפתק:");
                if (!text) return;
                const colors = ['bg-yellow-100', 'bg-blue-100', 'bg-green-100', 'bg-pink-100'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                state.notes.push({ id: Date.now(), text, color: randomColor });
                state.notes = [...state.notes];
            },

            delete(idx) {
                state.notes.splice(idx, 1);
                state.notes = [...state.notes];
            }
        };

        // --- App Core ---
        const App = {
            init() {
                Dashboard.renderHero();
                Budget.render();
                Rabbinate.render();
                Vendors.render();
                Notes.render();
                Dashboard.startTimer();
                this.navTo('home');
                
                // Restore inputs
                document.getElementById('guestsFamily').value = state.guests.family || '';
                document.getElementById('guestsFriends').value = state.guests.friends || '';
                document.getElementById('guestsWork').value = state.guests.work || '';
                Budget.calcGifts();
            },

            navTo(tabName) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${tabName}`).classList.remove('hidden');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if(btn.dataset.target === tabName) {
                        btn.classList.remove('text-dusk/40');
                        btn.classList.add('text-sageDark', 'scale-110');
                    } else {
                        btn.classList.add('text-dusk/40');
                        btn.classList.remove('text-sageDark', 'scale-110');
                    }
                });
            },

            openSettings() {
                document.getElementById('groomNameInput').value = state.couple.groom;
                document.getElementById('brideNameInput').value = state.couple.bride;
                document.getElementById('weddingDateInput').value = state.couple.date;
                document.getElementById('totalBudgetInput').value = state.totalBudget;
                document.getElementById('settingsModal').classList.remove('hidden');
            },

            closeSettings() {
                document.getElementById('settingsModal').classList.add('hidden');
            },

            saveSettings() {
                state.couple.groom = document.getElementById('groomNameInput').value;
                state.couple.bride = document.getElementById('brideNameInput').value;
                state.couple.date = document.getElementById('weddingDateInput').value;
                state.totalBudget = Number(document.getElementById('totalBudgetInput').value);
                
                // Force deep update
                state.couple = { ...state.couple };
                this.closeSettings();
            },

            confetti() {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#D0E6D2', '#F5F5DC', '#D4AF37']
                });
            }
        };

        // Expose to window for HTML onclick handlers
        window.App = App;
        window.Budget = Budget;
        window.Vendors = Vendors;
        window.Notes = Notes;
        window.Rabbinate = Rabbinate;

        App.init();

    </script>
</body>
</html>